<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>第5回あべはんカップ卓球大会 申込システム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- 定数定義 ---
        const ADMIN_HASH = "8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918"; // "admin"

        const TOURNAMENT_INFO = {
            name: '第５回あべはんカップ卓球大会',
            dates: '2026年5月23日（土）、24日（日）',
            location: '二戸市総合スポーツセンター'
        };

        const EVENTS_DAY1 = [
            { id: 'd1_1', name: '小学４年生以下男子の部' },
            { id: 'd1_2', name: '小学４年生以下女子の部' },
            { id: 'd1_3', name: '小学６年生以下男子 of' },
            { id: 'd1_3', name: '小学６年生以下男子の部' },
            { id: 'd1_4', name: '小学６年生以下女子の部' },
            { id: 'd1_5', name: '中学生男子の部' },
            { id: 'd1_6', name: '中学生女子の部' },
        ];

        const EVENTS_DAY2 = [
            { id: 'd2_1', name: '高校生男子の部' },
            { id: 'd2_2', name: '高校生女子の部' },
            { id: 'd2_3', name: '一般男子の部' },
            { id: 'd2_4', name: '一般女子の部' },
            { id: 'd2_5', name: 'ラージボール男子の部' },
            { id: 'd2_6', name: 'ラージボール女子の部' },
        ];

        const ALL_EVENTS = [...EVENTS_DAY1, ...EVENTS_DAY2];

        // --- ユーティリティ ---
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        const Icon = ({ name, size = 20, className = "" }) => {
            const LucideIcon = lucide.icons[name.charAt(0).toUpperCase() + name.slice(1)];
            return LucideIcon ? <LucideIcon size={size} className={className} /> : null;
        };

        function App() {
            // ステート管理
            const [view, setView] = useState('home');
            const [isAdminAuth, setIsAdminAuth] = useState(false);
            const [passInput, setPassInput] = useState("");
            const [loginError, setLoginError] = useState(false);
            
            const [applications, setApplications] = useState([]);
            const [eventSettings, setEventSettings] = useState(
                ALL_EVENTS.reduce((acc, event) => ({ ...acc, [event.id]: true }), {})
            );
            const [eventsStats, setEventsStats] = useState(
                ALL_EVENTS.reduce((acc, event) => ({ ...acc, [event.id]: 0 }), {})
            );

            const [formData, setFormData] = useState({
                teamName: '', repName: '', email: '', phone: '',
                players: [{ id: Date.now(), lastName: '', firstName: '', lastNameKana: '', firstNameKana: '', ageOrGrade: '', event23: '', event24: '', record: '' }]
            });

            // 統計の自動計算
            useEffect(() => {
                const stats = ALL_EVENTS.reduce((acc, event) => ({ ...acc, [event.id]: 0 }), {});
                applications.forEach(app => {
                    app.players.forEach(p => {
                        if (p.event23) stats[p.event23]++;
                        if (p.event24) stats[p.event24]++;
                    });
                });
                setEventsStats(stats);
            }, [applications]);

            const getEventName = (id) => ALL_EVENTS.find(e => e.id === id)?.name || '';

            // ログイン処理
            const handleLogin = async () => {
                const hashedInput = await sha256(passInput);
                if (hashedInput === ADMIN_HASH) {
                    setIsAdminAuth(true);
                    setView('adminDashboard');
                    setLoginError(false);
                    setPassInput("");
                } else {
                    setLoginError(true);
                }
            };

            // 申込処理
            const submitApplication = () => {
                const newApp = { ...formData, id: Date.now(), createdAt: new Date().toISOString() };
                setApplications([...applications, newApp]);
                setView('complete');
                // リセット
                setFormData({
                    teamName: '', repName: '', email: '', phone: '',
                    players: [{ id: Date.now(), lastName: '', firstName: '', lastNameKana: '', firstNameKana: '', ageOrGrade: '', event23: '', event24: '', record: '' }]
                });
            };

            const exportCSV = () => {
                let csv = "\uFEFF申込日,チーム名,代表者,電話,選手名,かな,学年,23日種目,24日種目,実績\n";
                applications.forEach(app => {
                    app.players.forEach(p => {
                        csv += `${app.createdAt},${app.teamName},${app.repName},${app.phone},${p.lastName}${p.firstName},${p.lastNameKana}${p.firstNameKana},${p.ageOrGrade},${getEventName(p.event23)},${getEventName(p.event24)},${p.record}\n`;
                    });
                });
                const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "abehan_cup_list.csv";
                link.click();
            };

            return (
                <div className="min-h-screen pb-20">
                    <header className="bg-white p-4 border-b shadow-sm flex justify-between items-center sticky top-0 z-50">
                        <div className="flex items-center gap-2 cursor-pointer" onClick={() => setView('home')}>
                            <div className="bg-blue-600 text-white p-2 rounded-lg font-black text-sm">卓</div>
                            <h1 className="font-black text-blue-900 hidden sm:block text-lg">あべはんカップ</h1>
                        </div>
                        <button 
                            onClick={() => setView(isAdminAuth ? 'adminDashboard' : 'adminLogin')} 
                            className="text-xs font-bold text-gray-500 bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg transition-colors"
                        >
                            管理者画面
                        </button>
                    </header>

                    <main className="p-4 sm:p-8 max-w-5xl mx-auto">
                        {/* ホーム画面 */}
                        {view === 'home' && (
                            <div className="space-y-8 animate-in fade-in">
                                <div className="bg-gradient-to-r from-blue-700 to-blue-500 rounded-3xl p-8 sm:p-16 text-center text-white shadow-xl">
                                    <h2 className="text-3xl sm:text-5xl font-black mb-4 italic">{TOURNAMENT_INFO.name}</h2>
                                    <p className="text-blue-100 text-lg mb-10 font-bold">{TOURNAMENT_INFO.dates} | {TOURNAMENT_INFO.location}</p>
                                    <button onClick={() => setView('form')} className="bg-yellow-400 text-blue-900 font-black px-12 py-5 rounded-2xl text-2xl shadow-lg hover:scale-105 transition-transform">今すぐ申し込む</button>
                                </div>
                                <div className="bg-white p-8 rounded-3xl shadow-lg">
                                    <h3 className="text-xl font-black mb-6 border-l-8 border-blue-600 pl-4">現在のエントリー状況（人数）</h3>
                                    <div className="grid sm:grid-cols-2 gap-8">
                                        <div>
                                            <h4 className="font-bold text-blue-600 mb-3">5/23(土)</h4>
                                            {EVENTS_DAY1.map(e => (
                                                <div key={e.id} className="flex justify-between p-3 border-b text-sm">
                                                    <span>{e.name}</span>
                                                    <span className="font-black">{eventsStats[e.id]} 名 {!eventSettings[e.id] && <span className="text-red-500 ml-2">〆</span>}</span>
                                                </div>
                                            ))}
                                        </div>
                                        <div>
                                            <h4 className="font-bold text-green-600 mb-3">5/24(日)</h4>
                                            {EVENTS_DAY2.map(e => (
                                                <div key={e.id} className="flex justify-between p-3 border-b text-sm">
                                                    <span>{e.name}</span>
                                                    <span className="font-black">{eventsStats[e.id]} 名 {!eventSettings[e.id] && <span className="text-red-500 ml-2">〆</span>}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 申込フォーム */}
                        {view === 'form' && (
                            <div className="bg-white p-6 sm:p-10 rounded-3xl shadow-xl animate-in slide-in-from-bottom-4">
                                <h2 className="text-2xl font-black mb-8 border-b pb-4 flex items-center">
                                    <Icon name="userPlus" className="mr-2 text-blue-600" /> 参加者情報の入力
                                </h2>
                                <div className="space-y-8">
                                    <div className="grid sm:grid-cols-2 gap-4 bg-gray-50 p-6 rounded-2xl">
                                        <input className="p-4 rounded-xl border-2 font-bold" placeholder="チーム名" value={formData.teamName} onChange={e => setFormData({...formData, teamName: e.target.value})} />
                                        <input className="p-4 rounded-xl border-2 font-bold" placeholder="代表者氏名" value={formData.repName} onChange={e => setFormData({...formData, repName: e.target.value})} />
                                        <input className="p-4 rounded-xl border-2 font-bold" placeholder="メールアドレス" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} />
                                        <input className="p-4 rounded-xl border-2 font-bold" placeholder="電話番号" value={formData.phone} onChange={e => setFormData({...formData, phone: e.target.value})} />
                                    </div>

                                    <div className="space-y-4">
                                        {formData.players.map((p, idx) => (
                                            <div key={p.id} className="p-6 border-2 rounded-2xl relative bg-white">
                                                <span className="absolute -top-3 -left-3 bg-blue-600 text-white w-8 h-8 rounded-lg flex items-center justify-center font-bold">{idx + 1}</span>
                                                {formData.players.length > 1 && (
                                                    <button onClick={() => setFormData({...formData, players: formData.players.filter(x => x.id !== p.id)})} className="absolute top-4 right-4 text-red-400"><Icon name="trash2" /></button>
                                                )}
                                                <div className="grid sm:grid-cols-2 gap-4 mt-2">
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <input className="p-3 border rounded-lg font-bold" placeholder="姓" value={p.lastName} onChange={e => {
                                                            const newPlayers = [...formData.players];
                                                            newPlayers[idx].lastName = e.target.value;
                                                            setFormData({...formData, players: newPlayers});
                                                        }} />
                                                        <input className="p-3 border rounded-lg font-bold" placeholder="名" value={p.firstName} onChange={e => {
                                                            const newPlayers = [...formData.players];
                                                            newPlayers[idx].firstName = e.target.value;
                                                            setFormData({...formData, players: newPlayers});
                                                        }} />
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <input className="p-3 border rounded-lg text-sm" placeholder="せい" value={p.lastNameKana} onChange={e => {
                                                            const newPlayers = [...formData.players];
                                                            newPlayers[idx].lastNameKana = e.target.value;
                                                            setFormData({...formData, players: newPlayers});
                                                        }} />
                                                        <input className="p-3 border rounded-lg text-sm" placeholder="めい" value={p.firstNameKana} onChange={e => {
                                                            const newPlayers = [...formData.players];
                                                            newPlayers[idx].firstNameKana = e.target.value;
                                                            setFormData({...formData, players: newPlayers});
                                                        }} />
                                                    </div>
                                                    <input className="p-3 border rounded-lg" placeholder="学年または年齢" value={p.ageOrGrade} onChange={e => {
                                                            const newPlayers = [...formData.players];
                                                            newPlayers[idx].ageOrGrade = e.target.value;
                                                            setFormData({...formData, players: newPlayers});
                                                    }} />
                                                    <input className="p-3 border rounded-lg" placeholder="大会実績（任意）" value={p.record} onChange={e => {
                                                            const newPlayers = [...formData.players];
                                                            newPlayers[idx].record = e.target.value;
                                                            setFormData({...formData, players: newPlayers});
                                                    }} />
                                                    <div>
                                                        <label className="text-[10px] font-bold text-gray-400">5/23(土) 種目</label>
                                                        <select className="w-full p-3 border rounded-lg" value={p.event23} onChange={e => {
                                                            const newPlayers = [...formData.players];
                                                            newPlayers[idx].event23 = e.target.value;
                                                            setFormData({...formData, players: newPlayers});
                                                        }}>
                                                            <option value="">不参加</option>
                                                            {EVENTS_DAY1.map(ev => <option key={ev.id} value={ev.id} disabled={!eventSettings[ev.id]}>{ev.name}{!eventSettings[ev.id] ? '(締切)' : ''}</option>)}
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-gray-400">5/24(日) 種目</label>
                                                        <select className="w-full p-3 border rounded-lg" value={p.event24} onChange={e => {
                                                            const newPlayers = [...formData.players];
                                                            newPlayers[idx].event24 = e.target.value;
                                                            setFormData({...formData, players: newPlayers});
                                                        }}>
                                                            <option value="">不参加</option>
                                                            {EVENTS_DAY2.map(ev => <option key={ev.id} value={ev.id} disabled={!eventSettings[ev.id]}>{ev.name}{!eventSettings[ev.id] ? '(締切)' : ''}</option>)}
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>

                                    <button onClick={() => setFormData({...formData, players: [...formData.players, { id: Date.now(), lastName: '', firstName: '', lastNameKana: '', firstNameKana: '', ageOrGrade: '', event23: '', event24: '', record: '' }]})} className="w-full py-4 border-2 border-dashed rounded-2xl text-gray-400 font-bold hover:bg-gray-50">+ 選手を追加する</button>

                                    <div className="flex gap-4 pt-10">
                                        <button onClick={() => setView('home')} className="flex-1 py-4 font-bold text-gray-400 bg-gray-100 rounded-xl">戻る</button>
                                        <button onClick={() => setView('confirm')} className="flex-2 bg-blue-600 text-white px-10 py-4 rounded-xl font-bold shadow-lg">確認画面へ</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 確認画面 */}
                        {view === 'confirm' && (
                            <div className="bg-white p-8 rounded-3xl shadow-xl max-w-2xl mx-auto animate-in zoom-in-95">
                                <h2 className="text-2xl font-black mb-6">申込内容の確認</h2>
                                <div className="space-y-4 mb-8">
                                    <div className="p-4 bg-gray-50 rounded-xl text-sm">
                                        <p><strong>チーム:</strong> {formData.teamName}</p>
                                        <p><strong>代表者:</strong> {formData.repName}</p>
                                    </div>
                                    {formData.players.map((p, idx) => (
                                        <div key={idx} className="p-4 border rounded-xl text-sm">
                                            <p className="font-bold">{p.lastName} {p.firstName} ({p.ageOrGrade})</p>
                                            <p className="text-gray-500 text-xs">23日: {getEventName(p.event23) || 'なし'} / 24日: {getEventName(p.event24) || 'なし'}</p>
                                        </div>
                                    ))}
                                </div>
                                <div className="flex gap-4">
                                    <button onClick={() => setView('form')} className="flex-1 py-4 font-bold text-gray-400 bg-gray-100 rounded-xl">修正する</button>
                                    <button onClick={submitApplication} className="flex-2 bg-green-600 text-white px-10 py-4 rounded-xl font-bold shadow-lg">この内容で申し込む</button>
                                </div>
                            </div>
                        )}

                        {/* 完了画面 */}
                        {view === 'complete' && (
                            <div className="text-center p-20 bg-white rounded-3xl shadow-xl max-w-xl mx-auto">
                                <Icon name="checkCircle" size={80} className="text-green-500 mx-auto mb-6" />
                                <h2 className="text-3xl font-black mb-4">申込が完了しました！</h2>
                                <p className="text-gray-500 mb-10 font-bold">当日、会場でお会いしましょう。</p>
                                <button onClick={() => setView('home')} className="bg-gray-900 text-white px-10 py-4 rounded-xl font-bold">トップに戻る</button>
                            </div>
                        )}

                        {/* ログイン画面 */}
                        {view === 'adminLogin' && (
                            <div className="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-xl border mt-10">
                                <h2 className="text-xl font-bold mb-6 text-center text-gray-800">事務局ログイン</h2>
                                <input 
                                    type="password" 
                                    className={`w-full border-2 p-4 rounded-xl mb-2 focus:border-blue-600 outline-none transition-all ${loginError ? 'border-red-500' : 'border-gray-100'}`}
                                    placeholder="パスワードを入力"
                                    value={passInput}
                                    onChange={(e) => setPassInput(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && handleLogin()}
                                />
                                {loginError && <p className="text-red-500 text-xs mb-4 font-bold text-center text-red-400">パスワードが正しくありません</p>}
                                <button onClick={handleLogin} className="w-full bg-gray-900 hover:bg-black text-white py-4 rounded-xl font-bold shadow-md">ログイン</button>
                            </div>
                        )}

                        {/* 管理ダッシュボード */}
                        {view === 'adminDashboard' && isAdminAuth && (
                            <div className="space-y-6">
                                <div className="flex justify-between items-center bg-white p-6 rounded-2xl shadow">
                                    <h2 className="font-black text-xl">管理ダッシュボード</h2>
                                    <div className="flex gap-2">
                                        <button onClick={exportCSV} className="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center"><Icon name="download" size={16} className="mr-2"/> CSV出力</button>
                                        <button onClick={() => {setIsAdminAuth(false); setView('home');}} className="bg-red-50 text-red-500 px-4 py-2 rounded-lg text-sm font-bold">ログアウト</button>
                                    </div>
                                </div>
                                <div className="grid lg:grid-cols-3 gap-6">
                                    <div className="bg-white p-6 rounded-2xl shadow">
                                        <h3 className="font-bold mb-4 border-b pb-2">受付停止・再開</h3>
                                        {ALL_EVENTS.map(e => (
                                            <div key={e.id} className="flex justify-between items-center mb-2 p-2 bg-gray-50 rounded">
                                                <span className="text-xs font-bold">{e.name}</span>
                                                <button 
                                                    onClick={() => setEventSettings({...eventSettings, [e.id]: !eventSettings[e.id]})}
                                                    className={`text-[10px] px-2 py-1 rounded font-bold ${eventSettings[e.id] ? 'bg-blue-100 text-blue-600' : 'bg-red-500 text-white'}`}
                                                >
                                                    {eventSettings[e.id] ? '受付中' : '停止中'}
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="lg:col-span-2 bg-white p-6 rounded-2xl shadow">
                                        <h3 className="font-bold mb-4 border-b pb-2">現在の申込リスト ({applications.length}件)</h3>
                                        <div className="space-y-4 max-h-[600px] overflow-y-auto px-2">
                                            {applications.map(app => (
                                                <div key={app.id} className="p-4 border rounded-xl text-sm relative">
                                                    <button onClick={() => setApplications(applications.filter(a => a.id !== app.id))} className="absolute top-4 right-4 text-red-300 hover:text-red-500"><Icon name="trash2" size={16}/></button>
                                                    <p className="font-black text-blue-800">{app.teamName} <span className="text-[10px] text-gray-400 font-normal">({new Date(app.createdAt).toLocaleDateString()})</span></p>
                                                    <p className="text-gray-500">代表: {app.repName} / {app.phone}</p>
                                                    <div className="mt-2 flex flex-wrap gap-2">
                                                        {app.players.map((pl, i) => (
                                                            <span key={i} className="bg-gray-100 px-2 py-1 rounded text-[10px]">{pl.lastName} {pl.firstName}</span>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                            {applications.length === 0 && <p className="text-center text-gray-300 py-20 font-bold">まだデータがありません</p>}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    <footer className="text-center text-[10px] font-bold text-gray-300 mt-10 uppercase tracking-widest">
                        © 2026 ABEHAN CUP COMMITTEE
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
